name: Synchronize Changes from key

on:
  workflow_call:
    inputs:
      target_repo:
        required: true
        type: string
      target_branch:
        required: true
        type: string
      commit_message:
        required: true
        type: string
      file_path:
        required: true
        type: string
      watched_population:
        required: true
        type: string
      watched_agriculture_gdp:
        required: true
        type: string
      watched_industry_gdp:
        required: true
        type: string
      watched_fdi_inflow:
        required: true
        type: string
    secrets:
      token:
        required: true

jobs:
  sync-data:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target_repo }}
          token: ${{ secrets.token }}
          ref: ${{ inputs.target_branch }}
          fetch-depth: 0

      - name: ğŸ” Compare and Update Values
        id: sync_values
        run: |
          pip install ruamel.yaml --quiet
          
          python3 <<EOF
          from ruamel.yaml import YAML
          import os

          # Input names must match workflow_call inputs exactly
          INPUT_MAP = {
              'population': '${{ inputs.watched_population }}',
              'agriculture_gdp': '${{ inputs.watched_agriculture_gdp }}',
              'industry_gdp': '${{ inputs.watched_industry_gdp }}',
              'fdi_inflow': '${{ inputs.watched_fdi_inflow }}'
          }

          TARGET_MAP = {
              'population': 'overview.population',
              'agriculture_gdp': 'sectors.agriculture.contribution_to_gdp',
              'industry_gdp': 'sectors.industry.contribution_to_gdp',
              'fdi_inflow': 'fdi.inflow_usd'
          }

          yaml = YAML()
          yaml.preserve_quotes = True
          yaml.width = 4096

          with open("${{ inputs.file_path }}") as f:
              target_data = yaml.load(f) or {}

          changes = []
          for input_key, target_path in TARGET_MAP.items():
              source_value = INPUT_MAP[input_key]
              keys = target_path.split('.')
              current = target_data
              for key in keys[:-1]:
                  current = current.setdefault(key, {})
              
              current_value = current.get(keys[-1], "")
              
              if source_value != str(current_value):
                  current[keys[-1]] = source_value
                  changes.append(target_path)

          if changes:
              with open("${{ inputs.file_path }}", "w") as f:
                  yaml.dump(target_data, f)
              print(f"Updated: {', '.join(changes)}")
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"changes={','.join(changes) if changes else 'none'}\n")
              f.write(f"no_change={'true' if not changes else 'false'}\n")
          EOF


      - name: ğŸš« Skip if no changes
        if: steps.sync_values.outputs.no_change == 'true'
        run: echo "âœ… All values up-to-date"

      - name: ğŸ·ï¸ Create Cert Update Branch
        if: steps.sync_values.outputs.no_change == 'false'
        id: branch_name
        run: |
          MAX=$(git ls-remote --heads origin "refs/heads/GHA_cert_update_*" | 
                awk -F'GHA_cert_update_' '{print $2}' | 
                sort -n | tail -n 1)
          NEXT=$(( ${MAX:-0} + 1 ))
          echo "BRANCH_NAME=GHA_cert_update_$NEXT" >> $GITHUB_OUTPUT
          git checkout -b "GHA_cert_update_$NEXT"

      - name: ğŸ“Œ Commit and push changes
        if: steps.sync_values.outputs.no_change == 'false'
        run: |
          git config --global user.email "github-actions@cert-update.com"
          git config --global user.name "Certificate Bot"
          git add "${{ inputs.file_path }}"
          git commit -m "${{ inputs.commit_message }}"
          git push origin "${{ steps.branch_name.outputs.BRANCH_NAME }}"

      - name: ğŸ‰ Create Certificate PR
        if: steps.sync_values.outputs.no_change == 'false'
        run: |
          # Install required packages
          pip install pyyaml --quiet

          # Safely extract country with error handling
          COUNTRY=$(python3 <<EOF
          import yaml, sys
          try:
              with open('${{ inputs.file_path }}') as f:
                  data = yaml.safe_load(f)
              print(data.get('country', 'UNKNOWN_COUNTRY'))
          except Exception as e:
              print(f"ERROR: {str(e)}", file=sys.stderr)
              print("UNKNOWN_COUNTRY")
              sys.exit(0)  # Don't fail the workflow
          EOF
          )

          # Map changed fields to simple names
          CHANGED_ENVS=$(echo '${{ steps.sync_values.outputs.changes }}' | 
                         sed 's/overview.population/population/g;
                              s/sectors.agriculture.contribution_to_gdp/agriculture/g;
                              s/sectors.industry.contribution_to_gdp/industry/g;
                              s/fdi.inflow_usd/inflow/g')

          # Create PR
          gh pr create \
            --base "${{ inputs.target_branch }}" \
            --head "${{ steps.branch_name.outputs.BRANCH_NAME }}" \
            --title "GHA Cert update to $COUNTRY" \
            --body "### Certificate Updates\n\n**Updated Fields:** ${CHANGED_ENVS//,/ }\n\n" \
            --label "${CHANGED_ENVS//,/, }" \
            --assignee "${{ github.actor }}"
        env:
          GH_TOKEN: ${{ secrets.token }}