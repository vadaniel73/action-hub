name: Create PR

on:
  workflow_call:
    inputs:
      target_repo:
        required: true
        type: string
      target_branch:
        required: true
        type: string
      commit_message:
        required: true
        type: string
      file_path:
        required: true
        type: string
      watched_exports_usd:
        required: true
        type: string
      watched_outlook:
        required: true
        type: string
    secrets:
      token:
        required: true

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target_repo }}
          token: ${{ secrets.token }}
          ref: ${{ inputs.target_branch }}

      - name: ðŸ”§ Update YAML & detect changes
        id: update
        run: |
          pip install ruamel.yaml --quiet
          python3 <<EOF
          from ruamel.yaml import YAML
          from pathlib import Path
          import os

          yaml = YAML()
          yaml.preserve_quotes = True
          yaml.width = 4096

          file_path = Path("${{ inputs.file_path }}")
          data = yaml.load(file_path)

          changes = []

          if data.get("trade", {}).get("exports_usd") != "${{ inputs.watched_exports_usd }}":
              data.setdefault("trade", {})["exports_usd"] = "${{ inputs.watched_exports_usd }}"
              changes.append("trade.exports_usd")

          if data.get("summary", {}).get("outlook") != "${{ inputs.watched_outlook }}":
              data.setdefault("summary", {})["outlook"] = "${{ inputs.watched_outlook }}"
              changes.append("summary.outlook")

          if changes:
              yaml.dump(data, file_path)
              with open(os.environ["GITHUB_ENV"], "a") as f:
                  f.write("CHANGES_DETECTED=true\n")
          else:
              with open(os.environ["GITHUB_ENV"], "a") as f:
                  f.write("CHANGES_DETECTED=false\n")
          EOF

      - name: ðŸ’¤ Skip if no changes
        if: env.CHANGES_DETECTED == 'false'
        run: echo "âœ… No changes. Skipping commit & PR."

      - name: ðŸ†• Create and push branch with changes
        if: env.CHANGES_DETECTED == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git fetch
          MAX=$(git branch -r | grep 'origin/value_change_gym_' | sed 's|.*_||' | sort -n | tail -1)
          NEXT=$((MAX + 1))
          [ -z "$MAX" ] && NEXT=1

          BRANCH="value_change_gym_${NEXT}"
          echo "BRANCH_NAME=$BRANCH" >> $GITHUB_ENV

          git checkout -b $BRANCH
          git add "${{ inputs.file_path }}"
          git commit -m "${{ inputs.commit_message }}"
          git push --set-upstream origin $BRANCH

      - name: ðŸš€ Create PR
        if: env.CHANGES_DETECTED == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.token }}
          commit-message: ${{ inputs.commit_message }}
          title: "ðŸ”„ Auto PR: Update watched keys"
          body: 'This PR updates `trade.exports_usd` and/or `summary.outlook` based on gym_buddy.'
          base: ${{ inputs.target_branch }}
          branch: ${{ env.BRANCH_NAME }}
