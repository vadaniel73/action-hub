name: Create PR

on:
  workflow_call:
    inputs:
      target_repo:
        required: true
        type: string
      target_branch:
        required: true
        type: string
      commit_message:
        required: true
        type: string
      file_path:
        required: true
        type: string
      watched_exports_usd:
        required: true
        type: string
      watched_outlook:
        required: true
        type: string
    secrets:
      token:
        required: true


jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target_repo }}
          token: ${{ secrets.token }}
          ref: ${{ inputs.target_branch }}


      - name: 🔍 Watched Key Values from gym_buddy and Mail_bot
        run: |
          echo "🔍 Watched Key Values from gym_buddy:"
          echo "➡️  trade.exports_usd = ${{ inputs.watched_exports_usd }}"
          echo "➡️  summary.outlook   = ${{ inputs.watched_outlook }}"
          pip install pyyaml --quiet
          python3 <<EOF
          import yaml
      
          def get_nested(data, key_path):
              keys = key_path.strip().split(".")
              for key in keys:
                  if isinstance(data, dict) and key in data:
                      data = data[key]
                  else:
                      return None
              return data
      
          with open("${{ inputs.file_path }}") as f:
              data = yaml.safe_load(f) or {}

          print("📬 Watched Key Values from Mail_bot:")
          print("➡️  trade.exports_usd = {}".format(get_nested(data, "trade.exports_usd")))
          print("➡️  summary.outlook   = {}".format(get_nested(data, "summary.outlook")))
          EOF
          
      

      - name: Compare watched keys using shared script
        id: check_keys
        run: |
          pip install pyyaml --quiet
          export WATCHED_KEYS='${{ inputs.watched_keys }}'
          python3 compare_keys.py
      
      

      - name: Exit if no relevant changes
        if: steps.check_keys.outputs.no_change == 'true'
        run: |
          echo "✅ No watched keys changed. Skipping PR."
          exit 0

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add "${{ inputs.file_path }}" || echo "⚠️ Nothing to add"
          git diff --cached --quiet || git commit -m "${{ inputs.commit_message }}"
          git push


      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.token }}
          commit-message: ${{ inputs.commit_message }}
          title: "Automated PR from workflow"
          body: "This PR was created automatically because watched keys were updated."
          branch: auto/pr-${{ github.run_id }}
